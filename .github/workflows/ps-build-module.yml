name: CI Build PowerShell Module
on:
  workflow_call:
    inputs:
      release-type:
        description: 'Release Type [Release/Prerelease/Debug]'
        required: false
        type: string
      publish:
        description: 'Publish release to PSGallery (Release only)'
        required: false
        type: boolean
        default: false
      module-list:
        description: 'Comma-separated list of PowerShell modules to install and cache'
        required: true
        type: string
    outputs:
      semantic-version:
        description: 'Semantic version determined by GitVersion'
        value: ${{ jobs.build.outputs.semantic-version }}

jobs:
  build:
    name: PowerShell Module
    runs-on: [ubuntu-latest]
    permissions:
      contents: write
    outputs:
      semantic-version: ${{ steps.version_step.outputs.GitVersion_MajorMinorPatch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4.2.0
        with:
          versionSpec: '6.5.x'
          preferLatestVersion: true

      - name: Determine Version
        id: version_step # step id used as a reference for output values
        uses: gittools/actions/gitversion/execute@v4.2.0
        with:
          configFilePath: gitversion.yml

      - name: Install and cache PowerShell modules
        uses: potatoqualitee/psmodulecache@v6.2.1
        with:
          modules-to-cache: ${{ inputs['module-list'] }}  
          shell: pwsh
          updatable: false

      - name: Run build via Invoke-Build
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          [void] (Import-Module InvokeBuild)
          $requestParam = @{
              ReleaseType     = '${{ inputs.release-type || 'Release' }}'
              SemanticVersion = '${{ steps.version_step.outputs.GitVersion_MajorMinorPatch }}'
              Task            = 'Build'
          }
          [void] (Invoke-Build @requestParam)

      - name: Run Export-CommandHelp via Invoke-Build
        shell: pwsh
        run: |
          # PlatyPS 1.0.1+ is not compatible with Set-StrictMode
          # New-MarkdownCommandHelp fails with:
          #  > The property 'inputTypes' cannot be found on this object. Verify that the property exists.
          Set-StrictMode -off
          [void] (Import-Module InvokeBuild)
          $requestParam = @{
              SemanticVersion = '${{ steps.version_step.outputs.GitVersion_MajorMinorPatch }}'
              Task            = 'Export-CommandHelp'
          }
          [void] (Invoke-Build @requestParam)

      - name: Upload build artifacts (if any)
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.ref_name }}-${{ steps.version_step.outputs.GitVersion_MajorMinorPatch }}
          path: build/**
          if-no-files-found: warn

      # Create a new tag based on the version determined by GitVersion
      # This is done BEFORE committing help to ensure the tag points to the verified PR merge commit
      - name: Create release tag
        if: github.ref_name == 'main'
        run: |
          git tag v${{ steps.version_step.outputs.GitVersion_MajorMinorPatch }}
          git push origin tag v${{ steps.version_step.outputs.GitVersion_MajorMinorPatch }}

      - name: Commit generated help
        if: github.ref_name == 'main'
        shell: bash
        run: |
          git status
          git add docs/help
          if git diff --cached --quiet; then
            echo "No help changes to commit"
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git status
          git commit -m "Update PowerShell help for release v${{ steps.version_step.outputs.GitVersion_MajorMinorPatch }}"

      - name: Push help updates
        if: github.ref_name == 'main'
        shell: bash
        run: |
          git push origin HEAD:main

      - name: Publish build package to PSGallery
        if: inputs.publish == true && inputs['release-type'] == 'Release'
        shell: pwsh
        env:
          NuGetApiKey: ${{ secrets.NuGetApiKey_PSGallery }}
        run: |
          Set-StrictMode -Version Latest
          [void] (Import-Module InvokeBuild)
          Invoke-Build -NugetApiKey ${{ env.NuGetApiKey }} -Task Publish